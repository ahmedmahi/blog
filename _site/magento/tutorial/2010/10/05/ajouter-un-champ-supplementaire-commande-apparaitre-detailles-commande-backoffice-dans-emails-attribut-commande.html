<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
<link rel="icon" href="/assets/images/logo.png">
    
<title>Ajouter un champ supplémentaire dans la commande - attribut commande | Blog MAHI</title>
    
 
 
    
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    
<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
    
<link href="/assets/css/screen.css" rel="stylesheet">
    
<link href="/assets/css/main.css" rel="stylesheet">
    
</head>
    

    

<body class="layout-post">

    
<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">
    
    <div class="container pr-0">    
    
    <!-- Begin Logo -->
    <a class="navbar-brand" href="/">
    <img src="/assets/images/logo.png" alt="Blog MAHI">
    </a>
    <!-- End Logo -->
  
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>
    
    
    <div class="collapse navbar-collapse" id="navbarMediumish">
       
        <!-- Begin Menu -->
        
            <ul class="navbar-nav ml-auto">
                
                
                <li class="nav-item">
                
                <a class="nav-link" href="/index.html">Blog</a>
                </li>
                
                
                <li class="nav-item">
                
                <a class="nav-link" href="/about">About</a>
                </li>
                
                <li class="nav-item">
                <a class="nav-link" href="/category/magento/"><i class="fab fa-magento"></i> Magento</a>
                </li>
                
                <li class="nav-item">
                <a  class="nav-link" href="/category/react/"><i class="fab fa-react"></i> React</a>
                </li>
                
                <li class="nav-item">
                <a  class="nav-link" href="/category/laravel/"><i class="fab fa-laravel"></i> Laravel</a>
                </li>

                <li class="nav-item">
                <a target="_blank" class="nav-link" href="https://github.com/ahmedmahi"><i class="fab fa-github"></i></a>
                </li>
                
                <li class="nav-item">
                <a target="_blank"  class="nav-link" href="https://twitter.com/ahmedmahi"><i class="fab fa-twitter"></i></a>
                </li>
                
            </ul>		
  
        <!-- End Menu -->

    </div>
        
    </div>
</nav>
<!-- End Navigation
================================================== -->
    
<div class="site-content">   
<div class="container">
    
<!-- Site Title
================================================== -->
<div class="mainheading">
    <!--h1 class="sitetitle">Blog MAHI</h1-->
    <p class="lead">
         Web - E-commerce - Mobile 
    </p>
</div>

    
    
<!-- Content
================================================== --> 
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
	<div class="row">

		<!-- Post Share -->
		<div class="col-md-2 pl-0">            
           <div class="share">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://twitter.com/intent/tweet?text=Ajouter un champ supplémentaire dans la commande - attribut commande&url=/magento/tutorial/2010/10/05/ajouter-un-champ-supplementaire-commande-apparaitre-detailles-commande-backoffice-dans-emails-attribut-commande.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <i class="fab fa-twitter"></i>
        </a>
        </li>
        
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://facebook.com/sharer.php?u=/magento/tutorial/2010/10/05/ajouter-un-champ-supplementaire-commande-apparaitre-detailles-commande-backoffice-dans-emails-attribut-commande.html" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
        <i class="fab fa-facebook-f"></i>
        </a>
        </li>
        
        <li class="ml-1 mr-1">
        <a target="_blank" href="https://plus.google.com/share?url=/magento/tutorial/2010/10/05/ajouter-un-champ-supplementaire-commande-apparaitre-detailles-commande-backoffice-dans-emails-attribut-commande.html" onclick="window.open(this.href, 'facebook-google', 'width=550,height=435');return false;">
        <i class="fab fa-google"></i>
        </a>
        </li>
        
    </ul>
    
    <div class="sep">
    </div>				
    <ul>
        <li> 
        <a  class="small smoothscroll" href="#disqus_thread"></a>
        </li>
    </ul>
    
</div>  
		</div>
		

		<!-- Post -->        
        
        
		<div class="col-md-9 flex-first flex-md-unordered">
			<div class="mainheading">

                <!-- Author Box -->
                				
				<div class="row post-top-meta">
					<div class="col-md-2">
						<img class="author-thumb" src="https://www.gravatar.com/avatar/e5420c92f230112dec8f064f2c6b67cc?s=250&d=mm&r=x" alt="Ahmed">
					</div>
					<div class="col-md-10">
						<a target="_blank" class="link-dark" href="https://mahi.ma">Ahmed</a><a target="_blank" href="https://twitter.com/ahmedmahi" class="btn follow">Follow</a>
						<span class="author-description">Ahmed MAHI consultant Technique web, e-commerce et mobile avec 10 ans d’expérience.</span>						
					</div>
				</div>				
                
                
                <!-- Post Title -->
				<h1 class="posttitle">Ajouter un champ supplémentaire dans la commande - attribut commande</h1> 
                
			</div>

			<!-- Post Featured Image -->
			<img class="featured-image img-fluid" src="/assets/images/champ-supplementaire-ommande.jpg" alt="Ajouter un champ supplémentaire dans la commande - attribut commande">
			<!-- End Featured Image -->

			<!-- Post Content -->
			<div class="article-post">
				<p>Supposant qu’on aime avoir une information supplémentaire sur la commande de notre client par exemple : “Heur de livraison souhaitée”, “au nom de”, commentaire….
Cette information qui doit être bien sur affiché dans les détailles de la commande et qu’on veut envoyer aussi pas les emails…
Aujourd’hui on va crée un petit module qui gère ca.
La structure de notre petit module :</p>

<p><img src="/assets/images/module_magento2.jpg" alt="attribut commande magento" /></p>

<p>Donc la première chose à faire est de penser comment stocker cette information
dans la BD Magento :
On va utiliser un attributs <img src="http://blog.ahmedmahi.com/wp-includes/images/smilies/icon_smile.gif" alt=":)" /> (heur_livraison)!
Dans notre fichier mysql4-install-0.1.0.php on va ajouter :</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nv">$installer</span> <span class="o">=</span> <span class="nv">$this</span><span class="p">;</span>
<span class="nv">$installer</span><span class="o">-&gt;</span><span class="na">startSetup</span><span class="p">();</span>
<span class="nv">$setup</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mage_Eav_Model_Entity_Setup</span><span class="p">(</span><span class="s1">'core_setup'</span><span class="p">);</span>
 
 
<span class="nv">$installer</span><span class="o">-&gt;</span><span class="na">getConnection</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">addColumn</span><span class="p">(</span>
        <span class="nv">$installer</span><span class="o">-&gt;</span><span class="na">getTable</span><span class="p">(</span><span class="s1">'sales_flat_order'</span><span class="p">),</span>
        <span class="s1">'heur_livraison'</span><span class="p">,</span>
        <span class="s1">'varchar(255) DEFAULT NULL AFTER `shipping_method`'</span>
<span class="p">);</span>
<span class="nv">$setup</span><span class="o">-&gt;</span><span class="na">startSetup</span><span class="p">();</span>
<span class="nv">$setup</span><span class="o">-&gt;</span><span class="na">addAttribute</span><span class="p">(</span><span class="s1">'order'</span><span class="p">,</span> <span class="s1">'heur_livraison'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'text'</span><span class="p">));</span>
<span class="nv">$installer</span><span class="o">-&gt;</span><span class="na">endSetup</span><span class="p">();</span>
</code></pre></div></div>

<p>Vous remarquez que ce n’est pas assez simple comme pour <a href="http://test.mahigento.com/ajouter-des-champs-specifiques-dans-linscription-dun-nouveau-client-magento">les attributs clients</a>, pour les commandes on a obligé d’ajouter une ligne dans la table «sales_flat_order» ou utiliser addAttribute des deux class Mage_Sales_Model_Mysql4_Setup et Mage_Sales_Model_Entity_Setup.
Donc cela va crée un attribut « commande ».
Maintenant je passe à la façon d’enregistrer la valeur de cet attribut.
Puisque c’est information déponde du mode de livraison donc je vais ajouter mon champ à la fin du fichier : checkout/ shipping_method/ available.phtml</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"heur_livraison_souhaitee"</span><span class="nt">&gt;&lt;strong&gt;</span>Heur de livraison souhaitée<span class="nt">&lt;/strong&gt;&lt;/label&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"input-box"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"heur_livraison_souhaitee"</span> <span class="na">id=</span><span class="s">"heur_livraison_souhaitee"</span>  <span class="na">class=</span><span class="s">"input-text validation-passed"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>Résultat dans onepage :</p>

<p><img src="/assets/images/magento_heure_livraison.jpg" alt="attribut heure livraison commande" /></p>

<p>L’action concernée est saveShippingMethod de la class Mage_Checkout_OnepageController :
Donc on peut surcharger la méthode ce que je ne préfère pas comme je dit toujours <img src="http://blog.ahmedmahi.com/wp-includes/images/smilies/icon_smile.gif" alt=":)" /> ou utiliser un observer, puisque il s’agit d’une action je vais utiliser l’event controller_action_postdispatch c’est mon préféré :).
Est donc dans le fichier config.xml :</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;events&gt;</span>
            <span class="nt">&lt;controller_action_postdispatch&gt;</span>
                <span class="nt">&lt;observers&gt;</span>
                    <span class="nt">&lt;mahigento_addattorder_gethls&gt;</span>
                        <span class="nt">&lt;type&gt;</span>singleton<span class="nt">&lt;/type&gt;</span>
                        <span class="nt">&lt;class&gt;</span>addattorder/observer<span class="nt">&lt;/class&gt;</span>
                        <span class="nt">&lt;method&gt;</span>getHeurLivraison<span class="nt">&lt;/method&gt;</span>
                    <span class="nt">&lt;/mahigento_addattorder_gethls&gt;</span>
                <span class="nt">&lt;/observers&gt;</span>
            <span class="nt">&lt;/controller_action_postdispatch&gt;</span>
            <span class="nt">&lt;sales_order_place_before&gt;</span>
                <span class="nt">&lt;observers&gt;</span>
                    <span class="nt">&lt;mahigento_addattorder_sethls&gt;</span>
                        <span class="nt">&lt;type&gt;</span>singleton<span class="nt">&lt;/type&gt;</span>
                        <span class="nt">&lt;class&gt;</span>addattorder/observer<span class="nt">&lt;/class&gt;</span>
                        <span class="nt">&lt;method&gt;</span>setHeurLivraison<span class="nt">&lt;/method&gt;</span>
                    <span class="nt">&lt;/mahigento_addattorder_sethls&gt;</span>
                <span class="nt">&lt;/observers&gt;</span>
            <span class="nt">&lt;/sales_order_place_before&gt;</span>
        <span class="nt">&lt;/events&gt;</span>
</code></pre></div></div>

<p>Il y’a en fait 2 observer que je vais utiliser car le premier de l’event controller_action_postdispatch c’est juste pour conservé la valeur du champ dans la session c’est le deuxième qu’on va utiliser pour l’enregistrement dans la commande
Les 2 observers sont lié au 2 méthodes de mon fichier Observer.php suivants :</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
 
<span class="k">class</span> <span class="nc">Mahigento_Addattorder_Model_Observer</span> <span class="p">{</span>
 
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getHeurLivraison</span><span class="p">(</span><span class="nv">$observer</span><span class="p">)</span> <span class="p">{</span>
 
        <span class="nv">$Controller</span> <span class="o">=</span> <span class="nv">$observer</span><span class="o">-&gt;</span><span class="na">getControllerAction</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$Controller</span> <span class="nx">instanceof</span> <span class="nx">Mage_Checkout_OnepageController</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$actionName</span> <span class="o">=</span> <span class="nv">$Controller</span><span class="o">-&gt;</span><span class="na">getFullActionName</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$actionName</span> <span class="o">==</span> <span class="s1">'checkout_onepage_saveShippingMethod'</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$Controller</span><span class="o">-&gt;</span><span class="na">getRequest</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getPost</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'heur_livraison'</span><span class="p">]))</span> <span class="p">{</span>
                    <span class="nx">Mage</span><span class="o">::</span><span class="na">getSingleton</span><span class="p">(</span><span class="s1">'core/session'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">setHeurLivraison</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'heur_livraison'</span><span class="p">]);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
 
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setHeurLivraison</span><span class="p">(</span><span class="nv">$observer</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$order</span> <span class="o">=</span> <span class="nv">$observer</span><span class="o">-&gt;</span><span class="na">getOrder</span><span class="p">();</span>
        <span class="nv">$session</span> <span class="o">=</span> <span class="nx">Mage</span><span class="o">::</span><span class="na">getSingleton</span><span class="p">(</span><span class="s1">'core/session'</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$session</span><span class="o">-&gt;</span><span class="na">hasHeurLivraison</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$order</span><span class="o">-&gt;</span><span class="na">setData</span><span class="p">(</span><span class="s1">'heur_livraison'</span><span class="p">,</span> <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">getHeurLivraison</span><span class="p">());</span>
            <span class="nv">$session</span><span class="o">-&gt;</span><span class="na">unsetHeurLivraison</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
 
<span class="p">}</span>
</code></pre></div></div>

<p>Le rôle de la première méthode est d’enregistré la valeur du champ si elle existe dans la session en attendant qu’avant directement le passage de la commande « sales_order_place_before » la méthode setHeurLivraison affecte la valeur de la session vers l’attribut commande.
Et enfin pour afficher la valeur dans les détails de la commande dans le backoffice on a qu’ajouter par exemple dans :
Design/adminhtml/default/default/template/sales/order/view/tab/info.phtml (ligne 79).</p>

<pre><code class="language-php+HTML">&lt;br /&gt;
&lt;?php echo $this-&gt;__('Heure de livraison souhaitée :'). $_order-
&gt;getHeurLivraison() ?&gt;
</code></pre>

<p>Résultat :</p>

<p><img src="/assets/images/information_livraison_magento_mahigento.jpg" alt="attribut commande magento" /></p>

<p>Et pour les emails on peut utiliser dans les gabaries la variable</p>

<blockquote>
  <p>{  {var order.heur_livraison }  }</p>
</blockquote>

<p>Noubliez pas de vider le cache et se déconnecté puis faites votre première commande test :).</p>

<p>Testé sur 1.4.1.0 et 1.4.1.1</p>

			</div>

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2010-10-05">05 Oct 2010</time></span>           
                
                </small>
            </p>
            
			<!-- Post Categories -->
			<div class="after-post-tags">
				<ul class="tags">
                    
                    
                    <li>
                     <a href="/category/magento/">magento</a>
                    </li>
                    
                    <li>
                     <a href="/category/tutorial/">tutorial</a>
                    </li>
                    
				</ul>
			</div>
			<!-- End Categories -->
            
            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="/magento/tutorial/2010/09/26/creation-client-code-sous-magento.html"> &laquo; Création d’un client a l’aide du code sous Magento</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="/magento/tutorial/2010/10/21/bargento-5-m-commerce-payement-a-lhonneur.html">Bargento 5 : M-commerce, payement à l’honneur &raquo; </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

		</div>
		<!-- End Post -->

	</div>
</div>
<!-- End Article
================================================== -->

  

<!-- Begin Comments
================================================== -->

    <div class="container">
        <div id="comments" class="row justify-content-center mb-5">
            <div class="col-md-8">              
                <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'ahmedmahi'; 
        var disqus_developer = 0;
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = window.location.protocol + '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
                
            </div>
        </div>
    </div>

<!--End Comments
================================================== -->
</div>


<!-- Bottom Alert Bar
================================================== -->
<div class="alertbar">
	<div class="container text-center">
		<span><img src="/assets/images/logo.png" alt=""> &nbsp; Abonnez-vous à la newsletter</span>
        <form action="https://mailchi.mp/e6becf892892/blogahmedmahi" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate>
            <div class="mc-field-group">
            <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required>
            <input type="submit" value="Je m'abonne" name="subscribe" class="heart">
            </div>
        </form>
	</div>
</div>    

    
</div><!-- /.container>
    
<!-- Categories Jumbotron
================================================== -->
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
          
             
              <a href="/category/magento">Magento (9)</a>
             
              <a href="/category/tutorial">Tutorial (9)</a>
            
          
        

		</div>
	</div>
</div>
 


<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                 Copyright © 2019 Blog MAHI 
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

   
</div> <!-- /.site-content>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
    
<script src="/assets/js/jquery.min.js"></script>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    
<script src="/assets/js/ie10-viewport-bug-workaround.js"></script>
    
<script src="/assets/js/mediumish.js"></script>
    
<script id="dsq-count-scr" src="//ahmedmahi.disqus.com/count.js"></script>
</body>
</html>
